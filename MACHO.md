## Mach-O文件和进程的映像(image)
iOS系统生成的可执行程序或者动态库文件的存储布局格式被称之为`Mach-O`格式。文件中存放着程序的代码和数据，而程序运行时系统会为其建立一个`进程`，以及`分配虚拟内存空间`。同时会把程序文件中的内容加载到虚拟内存地址空间中去，这种加载的方法一般采用`内存映射文件`的技术来实现。所谓的`映像`可以理解为将一个程序文件的内容加载到进程虚拟内存中的内容，**`也就是说进程的映像就是程序磁盘文件在内存中的一个副本`**。 一般来说一个进程中映像的内容和内存布局结构会和程序文件的内容以及存储布局结构一致，映像的首地址是一个 `mach_header`的结构体。映像中内容的排列布局和程序文件都是以段(Segment)为单位进行排列的。但是有一些情况映像的内存布局和内容可能会和程序文件的内存布局和内容不一致：

1. 映像中的数据段部分，因为数据段部分大多是可以被读写访问的，也就是说可以在运行时被修改，或者某些信息会进行rebase处理。因此数据段不能被进程之间共享，而是每个进程单独维护一份。当然为了效率和性能系统会采用一种称之为Copy on write的技术来实现单独副本的拷贝的。通常只有不可变的代码段部分才会是内存和文件中的内容保持一致，并且多进程共享。一个很常见的例子就是进程中加载的动态库和框架中的代码段部分通常都是所有进程共享。
2. 即使是代码段也有可能映像中的内容和程序文件中的内容不一致。有一些映像中的某些段的内容会是系统中缓存的段，而不是程序文件对应的段。一个很有代表性的例子就是CoreLocation这个库，当这个库被加载时你就会发现其映像中的有一些代码段的内容其实是系统缓存的内容而不是程序文件中的内容。

所以说程序文件和程序被加载后在内存中映像之间并不是一一对应的。程序文件和映像之间的关系就如程序和进程之间的关系是一样的。在程序运行后对其在进程中所有的Mach-O数据结构的访问都是基于映像而不是基于程序文件的。

